<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>الإقتباسات</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@700&display=swap');

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: sans-serif;
            background-color: #f3f3f3;
        }

        #editor {
            max-width: 600px;
            margin: 20px auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0px 0px 5px rgba(0, 0, 0, 0.2);
            padding: 30px;
        }

        label {
            margin-bottom: 10px;
            font-weight: bold;
            text-align: center;
            display: block;
        }

        #text {
            font-size: 20px;
            padding: 10px;
            border: 2px solid #dcdbdb;
            border-radius: 5px;
            margin-bottom: 20px;
            width: 100%;
            resize: none;
            font-family: 'Tajawal', sans-serif;
            direction: rtl;
        }

        #text:focus {
            outline: none;
            box-shadow: 0px 0px 5px rgba(0, 0, 0, 0.2);
            border-color: #0088cc;
        }

        #file {
            display: none;
        }

        .upload-label {
            background-color: #ddd;
            border-radius: 15px;
            font-weight: bold;
            cursor: pointer;
            color: #000;
            padding: 10px;
            transition: background-color 0.2s ease-in-out;
            margin-bottom: 20px;
        }

        .upload-label:hover {
            background-color: #bbb;
        }

        .upload-label:active {
            background-color: #aaa;
        }

        #image+.upload-label {
            display: inline-block;
        }

        #submit {
            background-color: #0088cc;
            color: #fff;
            padding: 10px 20px;
            border-radius: 15px;
            font-weight: bold;
            cursor: pointer;
            text-decoration: none;
            transition: background-color 0.2s ease-in-out;
            margin-bottom: 10px;
        }

        #submit:hover {
            background-color: #006699;
        }

        #submit:active {
            background-color: #005577;
        }

        #fontsize-input {
            margin: 15px 0;
        }

        #fontsize-input label {
            margin-right: 10px;
        }

        #fontsize-input input {
            width: 130px;
        }

        #canvas-container {
            max-width: 90%;
            margin: 0 auto;
            position: relative;
        }

        #canvas-container img {
            display: block;
            width: 100%;
            height: auto;
        }

        #canvas-container canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: auto;
        }

        @media (max-width: 630px) {
            #editor {
                position: absolute;
                width: 95%;
                top: 0px;
                right: 2.5%;
            }

            #text {
                font-size: 16px;
                padding: 5px;
            }

            #submit {
                font-size: 16px;
            }
        }
    </style>
</head>

<body>
<div id="editor">
    <label for="text">أضف الإقتباسات</label>
    <textarea id="text" rows="4"></textarea>
    <div id="fontsize-input">
        <label for="fontsize">حجم الخط</label>
        <input type="number" id="fontsize" name="fontsize" value="60" min="1" max="200">
    </div>
    <label class="upload-label" for="file">ارفع القالب</label>
    <input type="file" id="file">
    <a id="submit" download="edited-image.png">تحميل الإقتباس</a>

    <div id="canvas-container">
        <img id="image" src="">
        <canvas id="canvas"></canvas>
    </div>
</div>

<script>
    let editor = document.querySelector("#editor");
    let image = document.getElementById('image');
    let textInput = document.getElementById('text');
    let fileInput = document.getElementById('file');
    let submitButton = document.getElementById('submit');
    let canvas = document.getElementById('canvas');
    let ctx = canvas.getContext('2d');
    let fontSize = 60;
    let fontSizeInput = document.getElementById('fontsize');

    window.onload = () => { fontSizeInput.value = fontSize; }

    // رفع القالب واظهاره
    fileInput.addEventListener('change', function() {
        let file = this.files[0];
        let reader = new FileReader();
        reader.onload = function(event) {
            image.src = event.target.result;
            console.log(image.width, image.height, image.src);

            let waitSize = setInterval(() => { if(image.width > 0 && image.height > 0) {
                canvas.width = image.width;
                canvas.height = image.height;

                containerWidth = document.getElementById('canvas-container').offsetWidth;
                newHeight = containerWidth * image.height/image.width;

                canvas.style.height = `${newHeight}px`;

                ctx.drawImage(image, 0, 0);
                ctx.font = fontSize + 'px Tajawal';
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";

                updateText();
                clearInterval(waitSize);
            }});
        }
        reader.readAsDataURL(file);
    });

    // تغيير حجم النص
    fontSizeInput.addEventListener('input', function() {
        fontSize = parseInt(this.value);
        ctx.font = fontSize + 'px Tajawal';
        updateText();
    });

    // تغيير النص على القالب
    textInput.addEventListener('textInput', updateText);
    textInput.addEventListener('input', updateText);

    // دالة تغيير النص على القالب
    function updateText() {
        let lineHeight = fontSize * 1.3;
        let lines = textInput.value.split('\n');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        canvas.width == 0? ctx.drawImage(image, 0, 0) : ctx.drawImage(image, 0, 0, canvas.width, canvas.height);
        
        for (let i = 0; i < lines.length; i++) {
            let line = lines[i].trim();
            let textWidth = ctx.measureText(line).width;
            let x = canvas.width / 2;
            let y = canvas.height / 2 - ((lines.length - 1) * lineHeight / 2) + (lineHeight * i);
            ctx.fillText(line, x, y);
        }

        let dataURL = canvas.toDataURL("image/png");
        submitButton.href = dataURL;
    }

    // تنزيل الإقتباس
    submitButton.onclick = () => {
        submitButton.setAttribute("download", `${textInput.value.split('\n').join(" ")}.png`);
    };

</script>
</body>
</html>
